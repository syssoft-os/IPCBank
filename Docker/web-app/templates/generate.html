{% extends "/partial/base.html" %}

{% block title %}Dashboard{% endblock %}


{% block content %}

<h1>Generate & Configure Job</h1>

<div class="row row-cards">
  <div class="col-md-12 col-lg-8">
    <div class="row row-cards">
      
      <div class="col-12">
        <div class="card">
	  <div class="card-header">
	    <h3 class="card-title">Seed</h3>
	  </div>
	  <div class="card-body">
	    <div class="input-group">
	      <input id="random_seed" type="text" class="form-control" placeholder="Random Seed"></input>
	      <button class="btn btn-outline-primary" type="button" onclick="generateRandomSeed()"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-dice" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 3m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v14a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z" /><circle cx="8.5" cy="8.5" r=".5" fill="currentColor" /><circle cx="15.5" cy="8.5" r=".5" fill="currentColor" /><circle cx="15.5" cy="15.5" r=".5" fill="currentColor" /><circle cx="8.5" cy="15.5" r=".5" fill="currentColor" /></svg>Generate</button>
	    </div>
	  </div>
	</div>
      </div>

      <div class="col-12">
	<div class="card">
	  <div class="card-header">
	    <h3 class="card-title">Bank Settings</h3>
	  </div>
	  <div class="card-body row">
	    <h4 class="col-3">Number of Accounts</h4>
	    <div class="col-7" id="accounts" ></div>
	    <div class="col-2" style="text-align:right"  id="accounts-value">100</div>
	  </div>
	  <div class="card-body row">
	    <h4 class="col-3">Budget Range</h4>
	    <div class="col-7" id="budget" ></div>
	    <div class="col-2" style="text-align:right"  id="budget-value">100</div>
	  </div>
	  <div class="card-body row">
	    <h4 class="col-3">Transfer Range</h4>
	    <div class="col-7" id="transfer" ></div>
	    <div class="col-2" style="text-align:right"  id="transfer-value">100</div>
	  </div>
	</div>
      </div>

      <div class="col-12">
	<div class="card">
	  <div class="card-header">
	    <h3 class="card-title">Simulation Settings</h3>
	  </div>
	  <div class="card-body row">
	    <h4 class="col-3">Number of Clients</h4>
	    <div class="col-7" id="clients" ></div>
	    <div class="col-2" style="text-align:right"  id="clients-value">100</div>
	  </div>
	  <div class="card-body row">
	    <h4 class="col-3">Transactions per Client</h4>
	    <div class="col-7" id="transactions" ></div>
	    <div class="col-2" style="text-align:right"  id="transactions-value">100</div>
	  </div>
	</div>
      </div>




      <div class="col-12">
        <div class="card">
	  <div class="card-header">
	    <h3 class="card-title">Summary</h3>
	  </div>
	  <div class="card-body">
	    <table cellpadding="5">
	      <tbody><tr>
		  <td class="text-secondary text-truncate " style="vertical-align:top">Seed</td>
		  <td id="summary-seed" class="text-secondary text-truncate " style="white-space: normal;"></td>
		</tr>
		<tr>
		  <td class="text-secondary text-truncate ">Number of Accounts</td>
		  <td id="summary-accounts" class="text-secondary text-truncate "></td>
		</tr>
		<tr>
		  <td class="text-secondary text-truncate ">Budget Range</td>
		  <td id="summary-budget" class="text-secondary text-truncate "></td>
		</tr>
		<tr>
		  <td class="text-secondary text-truncate ">Transfer Range</td>
		  <td id="summary-transfer" class="text-secondary text-truncate "></td>
		</tr>
		<tr>
		  <td class="text-secondary text-truncate ">Number of Clients</td>
		  <td id="summary-clients" class="text-secondary text-truncate "></td>
		</tr>
		<tr>
		  <td class="text-secondary text-truncate ">Transactions per Clients</td>
		  <td id="summary-transactions" class="text-secondary text-truncate "></td>
		</tr>
	    </tbody></table>
	  </div>
	  <div class="card-footer">
            <div class="row align-items-center">
              <div class="col"></div>
              <div class="col-auto">
                <button onclick="addJob()" class="btn btn-primary">
                  Submit
                </button>
              </div>
            </div>
	  </div>
	</div>
      </div>



      
      
    </div>
  </div>

  <div class="col-md-12 col-lg-4">
    <div class="row row-cards">
      
      <div class="col-12">
	<div class="card">
	  <div class="card-header">
	    <h3 class="card-title">Computer Information</h3>
	  </div>
	  <div class="card-body px-0">
	    <div class="list-group list-group-flush">
	      <div class="list-group-item">
		<div class="row">
		  <div class="col-auto">
		    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-device-desktop" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 5a1 1 0 0 1 1 -1h16a1 1 0 0 1 1 1v10a1 1 0 0 1 -1 1h-16a1 1 0 0 1 -1 -1v-10z" /><path d="M7 20h10" /><path d="M9 16v4" /><path d="M15 16v4" /></svg>
		  </div>
		  <div class="col text-truncate">
		    <div>OS</div>
		    <div class="text-secondary text-truncate ">{{system_info["os"]}}</div>
		  </div>
		</div>
	      </div>
	      <div class="list-group-item">
		<div class="row">
		  <div class="col-auto">
		    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-cpu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 5m0 1a1 1 0 0 1 1 -1h12a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-12a1 1 0 0 1 -1 -1z" /><path d="M9 9h6v6h-6z" /><path d="M3 10h2" /><path d="M3 14h2" /><path d="M10 3v2" /><path d="M14 3v2" /><path d="M21 10h-2" /><path d="M21 14h-2" /><path d="M14 21v-2" /><path d="M10 21v-2" /></svg>
		  </div>
		  <div class="col">Processor
		    <table cellpadding="5">
		      <tr>
			<td class="text-secondary text-truncate " style="vertical-align:top">Model</td>
			<td class="text-secondary text-truncate " style="white-space: normal;">{{system_info["model"]}}</td>
		      </tr>
		      <tr>
			<td class="text-secondary text-truncate " >Architecture</td>
			<td class="text-secondary text-truncate ">{{system_info["arch"][0]}}</td>
		      </tr>
		      <tr>
			<td class="text-secondary text-truncate ">Cores</td>
			<td class="text-secondary text-truncate ">{{system_info["cores"]}}</td>
		      </tr>
		      <tr>
			<td class="text-secondary text-truncate ">Threads</td>
			<td class="text-secondary text-truncate ">{{system_info["threads"]}}</td>
		      </tr>
		      <tr>
			<td class="text-secondary text-truncate ">Ram</td>
			<td class="text-secondary text-truncate ">{{system_info["r_t"]}} GB</td>
		      </tr>
		      <tr>
			<td class="text-secondary text-truncate ">CPU Frequency</td>
			<td class="text-secondary text-truncate ">{{system_info["freq"]}} MHz</td>
		      </tr>
		    </table>
		  </div>
		</div>
	      </div>
	    </div>
	  </div>
	</div>
      </div>


      <div class="col-12">
        <div class="card">
	  <div class="card-header">
	    <h3 class="card-title">Test Seed</h3>
	    <div class="card-actions">
	      <div id="test_seed_button_container" class="col-6 col-sm-4 col-md-2 col-xl-auto">
		<button id="test_seed_button" class="btn btn-green  w-100 btn-icon" aria-label="Tabler" onclick="testSeed()">
		  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-player-play" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M7 4v16l13 -8z"></path></svg>
		</button>
	      </div>
	    </div>
          </div>
	  <div class="card-body">
	    <div class="list-group list-group-flush">

	      <div class="list-group-item">
		<div class="row">
		  <div class="col-auto">
		    <img width="24" src="{{ url_for('static', filename='/svg/c.svg') }}">
		  </div>
		  <div class="col text-truncate">
		    <div>C</div>
		    <div  id="random_c_value" class="text-secondary text-truncate "></div>
		  </div>
		</div>
	      </div>
	      
	      <div class="list-group-item">
		<div class="row">
		  <div class="col-auto"> 
		    <img width="24" src="{{ url_for('static', filename='/svg/python.svg') }}">
		  </div>
		  <div class="col text-truncate">
		    <div>Python</div>
		    <div  id="random_python_value" class="text-secondary text-truncate "></div>
		  </div>
		</div>
	      </div>

	      <div class="list-group-item">
		<div class="row">
		  <div class="col-auto">
		    <img width="24" src="{{ url_for('static', filename='/svg/java.svg') }}">
		  </div>
		  <div class="col text-truncate">
		    <div>Java</div>
		    <div id="random_java_value" class="text-secondary text-truncate "></div>
		  </div>
		</div>
	      </div>

	      <div class="list-group-item">
		<div class="row">
		  <div class="col-auto">
		    <img width="24" src="{{ url_for('static', filename='/svg/clojure.svg') }}">
		  </div>
		  <div class="col text-truncate">
		    <div>Clojure</div>
		    <div id="random_clojure_value" class="text-secondary text-truncate "></div>
		  </div>
		</div>
	      </div>
	      
	    </div>
	  </div>
	</div>
      </div>



      
    </div>
  </div>
  
</div>


<div class="modal modal-blur fade" id="job-success" tabindex="-1" style="display: none;" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-success"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-green icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path><path d="M9 12l2 2l4 -4"></path></svg>
        <h3>Job registered</h3>
        <div class="text-secondary">The Job has been succesfully added to the JobList. You can view the full Job List in the Dashboard.</div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col"><a href="/" class="btn w-100">
                Go to dashboard
            </a></div>
            <div class="col"><a href="#" class="btn btn-success w-100" data-bs-dismiss="modal">
                Add another Job
            </a></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<div class="modal modal-blur fade" id="job-failed" tabindex="-1" role="dialog" style="display: none;" aria-modal="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-danger"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-danger icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 9v4"></path><path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z"></path><path d="M12 16h.01"></path></svg>
        <h3>Failed to add the Job</h3>
        <div class="text-secondary">Failed to add the Job to the JobList</div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col"><a href="/" class="btn w-100">
                Go to dashboard
            </a></div>
            <div class="col"><a href="#" class="btn btn-danger w-100" data-bs-dismiss="modal">
                Try Again Later
            </a></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function formatNumberWithPoints(number) {
      return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
  
  function updateSummary() {
      updateSliderSummary('accounts', 'summary-accounts');
      updateSliderSummary('budget', 'summary-budget');
      updateSliderSummary('transfer', 'summary-transfer');
      updateSliderSummary('clients', 'summary-clients');
      updateSliderSummary('transactions', 'summary-transactions');
      document.getElementById('summary-seed').textContent = document.getElementById('random_seed').value;
  }

  function updateSliderSummary(sliderId, summaryId) {
      var slider = document.getElementById(sliderId).noUiSlider;
      if (slider) {
	  var sliderValue = slider.get();
	  var formattedValue = Array.isArray(sliderValue)
              ? formatNumberWithPoints(Math.round(sliderValue[0])) + " - " + formatNumberWithPoints(Math.round(sliderValue[1]))
              : formatNumberWithPoints(Math.round(sliderValue));

	  document.getElementById(summaryId).textContent = formattedValue;
      }
  }

  document.addEventListener("DOMContentLoaded", function () {
      updateSummary();
      var randomSeedInput = document.getElementById('random_seed');
      randomSeedInput.addEventListener('input', updateSummary);
  });
</script>

<script>
  function addJob() {


      var formData = new FormData();

      formData.append('seed',  document.getElementById('random_seed').value);
      formData.append('number_of_accounts', document.getElementById('accounts').noUiSlider.get());
      formData.append('budget_min', document.getElementById('budget').noUiSlider.get()[0]);
      formData.append('budget_max', document.getElementById('budget').noUiSlider.get()[1]);
      formData.append('transfer_min', document.getElementById('transfer').noUiSlider.get()[0]);
      formData.append('transfer_max', document.getElementById('transfer').noUiSlider.get()[1]);
      formData.append('number_of_clients', document.getElementById('clients').noUiSlider.get());
      formData.append('transactions_per_client', document.getElementById('transactions').noUiSlider.get());

      

      fetch('/api/job/add', {
          method: 'POST',
          body: formData
      })
	  .then(response => response.text())
	  .then(data => {
              if (data === "1") {
		  var myModal = new bootstrap.Modal(document.getElementById("job-success"), {});
		  myModal.show();
              } else if (data === "-1") {
		  var myModal = new bootstrap.Modal(document.getElementById("job-failed"), {});
		  myModal.show();
              } else {
		  var myModal = new bootstrap.Modal(document.getElementById("job-failed"), {});
		  myModal.show();
		  console.log("Unexpected response:", data);
              }
	  })
	  .catch(error => {
              console.error("Error:", error);
	  });
  }
</script>




<script>
  

  document.addEventListener("DOMContentLoaded", function () {
      var accountsSlider = document.getElementById('accounts');

      noUiSlider.create(accountsSlider, {
	  start: 50,
	  step:1,
	  connect: [true, false],
	  range: {
              min: 10,
              max: 1000
	  },
	  
      });

      accountsSlider.noUiSlider.on('update', function (values, handle) {
	  document.getElementById('accounts-value').textContent = formatNumberWithPoints(Math.round(values));
	  updateSummary();
      });

  });

</script>
<script>
  

  document.addEventListener("DOMContentLoaded", function () {
      var budgetSlider = document.getElementById('budget');

      noUiSlider.create(budgetSlider, {
	  start: [50000, 100000],
	  behaviour: 'drag-all',
	  step: 1,
    	  connect: [false, true, false],
	  range: {
              min: 100,
              max: 999999
	  },
	  
      });
      budgetSlider.noUiSlider.on('update', function (values, handle) {
	  document.getElementById('budget-value').textContent = formatNumberWithPoints(Math.round(values[0])) + " - " + formatNumberWithPoints(Math.round(values[1]));
	  updateSummary();
      });

      budgetSlider.noUiSlider.on('change', function (values, handle) {
	  var transferSlider = document.getElementById('transfer');
	  
	  if(parseInt(transferSlider.noUiSlider.get()[0]) > parseInt(budgetSlider.noUiSlider.get()[1])){
	      transferSlider.noUiSlider.set([budgetSlider.noUiSlider.get()[0], budgetSlider.noUiSlider.get()[1]])
	  }
	  

	  if(parseInt(transferSlider.noUiSlider.get()[1]) > parseInt(budgetSlider.noUiSlider.get()[1])){
	      transferSlider.noUiSlider.set([transferSlider.noUiSlider.get()[0], budgetSlider.noUiSlider.get()[1]])
	  }
	  
      });

  });
</script>
<script>
  

  document.addEventListener("DOMContentLoaded", function () {
      var transferSlider = document.getElementById('transfer');

      noUiSlider.create(transferSlider, {
	  start: [100, 10000],
	  behaviour: 'drag-all',
	  step: 1,
    	  connect: [false, true, false],
	  range: {
              min: 100,
              max: 100000
	  },
	  
      });
      transferSlider.noUiSlider.on('update', function (values, handle) {
	  document.getElementById('transfer-value').textContent = formatNumberWithPoints(Math.round(values[0])) + " - " + formatNumberWithPoints(Math.round(values[1]));
	  updateSummary();
      });

      transferSlider.noUiSlider.on('change', function (values, handle) {
	  var budgetSlider = document.getElementById('budget');

	  if(parseInt(transferSlider.noUiSlider.get()[0]) > parseInt(budgetSlider.noUiSlider.get()[1])){
	      transferSlider.noUiSlider.set([budgetSlider.noUiSlider.get()[0], budgetSlider.noUiSlider.get()[1]])
	  }
	  
	  if(parseInt(transferSlider.noUiSlider.get()[1]) > parseInt(budgetSlider.noUiSlider.get()[1])){
	      transferSlider.noUiSlider.set([transferSlider.noUiSlider.get()[0], budgetSlider.noUiSlider.get()[1]])
	  }
	  
	  
      });

  });
</script>
<script>
  

  document.addEventListener("DOMContentLoaded", function () {
      var clientsSlider = document.getElementById('clients');

      noUiSlider.create(clientsSlider, {
	  start: 10,
	  connect: [true, false],
	  step:1,
	  range: {
              min: 1,
              max: 50
	  },
	  
      });
      clientsSlider.noUiSlider.on('update', function (values, handle) {
	  document.getElementById('clients-value').textContent = formatNumberWithPoints(Math.round(values));
	  updateSummary();
      });

  });

</script>


<script>
  

  document.addEventListener("DOMContentLoaded", function () {
      var transactionsSlider = document.getElementById('transactions');

      noUiSlider.create(transactionsSlider, {
	  start: 10000,
	  behaviour: 'drag-all',
	  step: 1,
    	  connect: [true, false],
	  range: {
              min: 1,
              max: 100000
	  },
	  
      });
      transactionsSlider.noUiSlider.on('update', function (values, handle) {
	  document.getElementById('transactions-value').textContent = formatNumberWithPoints(Math.round(values));
	  updateSummary();
      });
  });
</script>


<script>
  function generateRandomSeed() {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';

      for (let i = 0; i < 16; i++) {
	  const randomIndex = Math.floor(Math.random() * characters.length);
	  result += characters.charAt(randomIndex);
      }

      document.getElementById('random_seed').value = result;
      
      updateSummary();
      return result;
  }

  generateRandomSeed();
  
</script>



<script>
  var eventSource;
  var data = {};

  function setPlaceholderOrValue(id, stop) {
      var place_holder = '<div class="placeholder placeholder-xs col-6"></div>';

      if (stop) {
          document.getElementById(id).classList.remove("placeholder-glow");
      }

      if (id in data) {
          document.getElementById(id).innerHTML = data[id];
      } else {
          document.getElementById(id).classList.add("placeholder-glow");
	  document.getElementById(id).innerHTML = place_holder;
      }
  }

  function testSeed() {
      var randomSeed = document.getElementById('random_seed').value;

      document.getElementById('test_seed_button').disabled = true;
      data = {}; 

      setPlaceholderOrValue('random_c_value');
      setPlaceholderOrValue('random_python_value');
      setPlaceholderOrValue('random_java_value');
      setPlaceholderOrValue('random_clojure_value');

      eventSource = new EventSource('/stream/seed?seed=' + randomSeed);

      eventSource.onmessage = function (event) {
          if (event.data === "-1") {
              eventSource.close();
              document.getElementById('test_seed_button').disabled = false;
              setPlaceholderOrValue('random_c_value', true);
              setPlaceholderOrValue('random_python_value', true);
              setPlaceholderOrValue('random_java_value', true);
              setPlaceholderOrValue('random_clojure_value', true);
          } else {
              var json = JSON.parse(event.data);
              data = json;
              setPlaceholderOrValue('random_c_value');
              setPlaceholderOrValue('random_python_value');
              setPlaceholderOrValue('random_java_value');
              setPlaceholderOrValue('random_clojure_value');
          }
      };

      eventSource.onerror = function (error) {
          console.error('EventSource failed:', error);
          eventSource.close();
          document.getElementById('test_seed_button').disabled = false;
          setPlaceholderOrValue('random_c_value', true);
          setPlaceholderOrValue('random_python_value', true);
          setPlaceholderOrValue('random_java_value', true);
          setPlaceholderOrValue('random_clojure_value', true);
      };
  }

  </script>





{% endblock %}
